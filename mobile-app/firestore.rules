rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection
    // - Allow users to read their own user document
    // - Allow users to write their own document
    // - Additionally allow users with role == 'Admin' to write (create/update/delete) other user documents
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;

      // Write rules:
      // - Admins (determined by their own user doc role) can write any user document (including role changes).
      // - Owners can write their own document but may not escalate role to Admin when updating.
      // Note: be careful when accessing request.resource which is null on deletes.
      allow write: if request.auth != null && (
        // Admins can write any user doc. Accept both legacy 'admin' and normalized 'Admin'.
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin'
          || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
        )
        // Owners can write their own doc. If this is an update/create the new role must not be 'Admin'.
        || (
          request.auth.uid == userId
          && (
            // If there's a request.resource (create/update), ensure role is not escalated to Admin.
            // For deletes request.resource is null, allow owner delete (preventing accidental lockouts is a UX choice).
            (request.resource != null ? request.resource.data.role != 'Admin' : true)
          )
        )
      );
    }
    
    // Allow authenticated users to read and write their own settings
    match /userSettings/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Additional collections needed for the app
    match /{collection}/{document=**} {
      allow read: if request.auth != null;
      // For other collections, you might want to add more specific rules
    }
  }
}